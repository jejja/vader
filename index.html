<!doctype html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>V√§der ‚Äì dag & timme</title>

    <style>
      :root {
        --bg: #020617;
        --card: #1e293b;
        --accent: #38bdf8;
        --text: #e5e7eb;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: linear-gradient(160deg, #020617, #0f172a);
        color: var(--text);
      }

      header {
        max-width: 1100px;
        margin: 0 auto;
        padding: 2rem 1rem 1rem;
      }

      h1 {
        margin: 0;
        text-align: center;
        color: var(--accent);
      }

      .sub {
        text-align: center;
        opacity: 0.8;
        margin-top: 0.5rem;
        font-size: 0.95rem;
      }

      .topbar {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 1rem 1rem;
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        flex-wrap: wrap;
      }

      button {
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(255,255,255,.06);
        color: var(--text);
        border-radius: 12px;
        padding: 0.6rem 0.9rem;
        cursor: pointer;
      }

      button:hover { filter: brightness(1.08); }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .status {
        max-width: 1100px;
        margin: 0 auto;
        padding: 0 1rem 1rem;
        text-align: center;
        opacity: 0.9;
      }

      .status small { opacity: 0.85; }

      .days {
        max-width: 1100px;
        margin: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      .day-card {
        background: var(--card);
        border-radius: 18px;
        padding: 1rem;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      }

      .day-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .day-header h2 {
        margin: 0;
        font-size: 1.2rem;
        text-transform: capitalize;
      }

      .day-header span {
        opacity: 0.8;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      .hourly {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 0.75rem;
      }

      .hour {
        background: #0f172a;
        border-radius: 14px;
        padding: 0.75rem;
        text-align: center;
      }

      .time {
        font-size: 0.8rem;
        opacity: 0.7;
      }

      .temp {
        font-size: 1.3rem;
        font-weight: 800;
        color: var(--accent);
      }

      .desc {
        font-size: 0.75rem;
        opacity: 0.9;
        min-height: 2.1em;
      }

      .wind {
        font-size: 0.72rem;
        opacity: 0.9;
        margin-top: 0.35rem;
        line-height: 1.3;
      }

      footer {
        max-width: 1100px;
        margin: 0 auto;
        padding: 1rem 1rem 2rem;
        opacity: 0.85;
        font-size: 0.9rem;
      }

      footer a { color: inherit; }

      /* ====== IKONER + ANIMATIONER ====== */
      .icon {
        font-size: 1.6rem;
        margin: 0.3rem 0;
      }

      .sun { animation: spin 8s linear infinite; }
      .moon { animation: pulse 3s ease-in-out infinite; }
      .cloud { animation: float 4s ease-in-out infinite; }
      .rain { animation: drop 1.5s linear infinite; }
      .snow { animation: float 3s ease-in-out infinite; }
      .sleet { animation: float 3s ease-in-out infinite; }
      .storm { animation: pulse 1.2s infinite; }

      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      @keyframes pulse { 0%,100% { opacity: .6 } 50% { opacity: 1 } }
      @keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
      @keyframes drop { 0% { transform: translateY(0); opacity: 1 } 100% { transform: translateY(6px); opacity: .4 } }
    </style>
  </head>

  <body>
    <header>
      <h1>üå¶Ô∏è V√§derprognos ‚Äì Karlskrona</h1>
      <div class="sub">Timprognos (5 dagar) fr√•n SMHIs √∂ppna data.</div>
    </header>

    <div class="topbar">
      <button id="btnRefresh" type="button">Uppdatera</button>
      <button id="btnForce" type="button" title="Ignorerar cache och h√§mtar ny data fr√•n SMHI">
        Tvinga uppdatering
      </button>
    </div>

    <div id="status" class="status" aria-live="polite"></div>
    <div id="days" class="days"></div>

    <footer class="day-card">
      <strong>K√§lla & licens</strong><br />
      K√§lla: SMHI (Sveriges meteorologiska och hydrologiska institut), √∂ppna data.
      Licens: Creative Commons Erk√§nnande 4.0 (CC BY 4.0).<br />
      Denna webbsida √§r en <em>bearbetning</em> av datan (urval/visualisering).
      L√§s villkor:
      <a href="https://www.smhi.se/data/om-smhis-data/villkor-for-anvandning" target="_blank" rel="noopener noreferrer">
        SMHIs villkor f√∂r anv√§ndning
      </a>.
      
      <div style="margin-top:0.5rem;">
        <small>F√∂r att undvika on√∂dig belastning cacheas svaret lokalt i webbl√§saren en stund innan ny h√§mtning g√∂rs.</small>
      </div>
    </footer>

    <script>
      // =========================
      // Inst√§llningar
      // =========================
      const PLACE = "Karlskrona";
      const LAT = 56.161;
      const LON = 15.587;

      // Rimlig cachning f√∂r att undvika on√∂diga anrop
      const CACHE_TTL_MS = 15 * 60 * 1000;

      const container = document.getElementById("days");
      const statusEl = document.getElementById("status");
      const btnRefresh = document.getElementById("btnRefresh");
      const btnForce = document.getElementById("btnForce");

      const SMHI_URL =
        `https://opendata-download-metfcst.smhi.se/api/category/pmp3g/version/2/geotype/point/lon/${LON}/lat/${LAT}/data.json`;

      const CACHE_KEY = `smhi:pmp3g:v2:${LON}:${LAT}`;

      // ====== Wsymb2-beskrivningar ======
      const descriptions = {
        1: "Klart",
        2: "N√§stan klart",
        3: "V√§xlande molnighet",
        4: "Halvklart",
        5: "Molnigt",
        6: "Mulet",
        7: "Dimma",
        8: "L√§tta regnskurar",
        9: "M√•ttliga regnskurar",
        10: "Kraftiga regnskurar",
        11: "√Öskv√§der",
        12: "L√§tta byar med bl√∂tsn√∂",
        13: "M√•ttliga byar med bl√∂tsn√∂",
        14: "Kraftiga byar med bl√∂tsn√∂",
        15: "L√§tta sn√∂byar",
        16: "M√•ttliga sn√∂byar",
        17: "Kraftiga sn√∂byar",
        18: "L√§tt regn",
        19: "M√•ttligt regn",
        20: "Kraftigt regn",
        21: "√Öska",
        22: "L√§tt bl√∂tsn√∂",
        23: "M√•ttlig bl√∂tsn√∂",
        24: "Kraftig bl√∂tsn√∂",
        25: "L√§tt sn√∂fall",
        26: "M√•ttligt sn√∂fall",
        27: "Kraftigt sn√∂fall"
      };

      function fmtLocalDateTime(msOrIso) {
        const d = typeof msOrIso === "number" ? new Date(msOrIso) : new Date(msOrIso);
        return new Intl.DateTimeFormat("sv-SE", { dateStyle: "medium", timeStyle: "short" }).format(d);
      }

      function setStatus({ message, source, fetchedAt, note } = {}) {
        const parts = [];
        if (message) parts.push(message);

        if (fetchedAt) {
          parts.push(`<small>Senast uppdaterad: <strong>${fmtLocalDateTime(fetchedAt)}</strong></small>`);
        }

        if (source) {
          parts.push(`<small>K√§lla f√∂r denna visning: <strong>${source}</strong></small>`);
        }

        if (note) {
          parts.push(`<small>${note}</small>`);
        }

        statusEl.innerHTML = parts.join("<br>");
      }

      function setLoading(isLoading) {
        btnRefresh.disabled = isLoading;
        btnForce.disabled = isLoading;
      }

      function isDay(isoTime) {
        const hour = new Date(isoTime).getHours();
        return hour >= 6 && hour < 18;
      }

      function windDirection(deg) {
        const dirs = ["N", "NO", "O", "SO", "S", "SV", "V", "NV"];
        return dirs[Math.round(deg / 45) % 8];
      }

      function windStrength(ms) {
        if (!Number.isFinite(ms)) return "‚Äî";
        if (ms < 1) return "Lugnt";
        if (ms < 4) return "Svag vind";
        if (ms < 8) return "M√•ttlig vind";
        if (ms < 14) return "Frisk vind";
        if (ms < 21) return "H√•rd vind";
        return "Storm";
      }

      function icon(code, day) {
        if (code === 1 || code === 2) return day ? "‚òÄÔ∏è sun" : "üåô moon";
        if (code === 3 || code === 4) return day ? "üå§Ô∏è cloud" : "‚òÅÔ∏è cloud";
        if (code >= 5 && code <= 7) return code === 7 ? "üå´Ô∏è cloud" : "‚òÅÔ∏è cloud";
        if (code >= 8 && code <= 10) return "üå¶Ô∏è rain";
        if (code === 11 || code === 21) return "‚õàÔ∏è storm";
        if (code >= 12 && code <= 14) return "üå®Ô∏è sleet";
        if (code >= 15 && code <= 17) return "üå®Ô∏è snow";
        if (code >= 18 && code <= 20) return "üåßÔ∏è rain";
        if (code >= 22 && code <= 24) return "üå®Ô∏è sleet";
        if (code >= 25 && code <= 27) return "‚ùÑÔ∏è snow";
        return "‚ùì cloud";
      }

      function param(series, name, fallback = null) {
        const p = series.parameters?.find(x => x.name === name);
        return (p && Array.isArray(p.values) && p.values.length) ? p.values[0] : fallback;
      }

      function loadCache() {
        try {
          const raw = localStorage.getItem(CACHE_KEY);
          if (!raw) return null;
          const obj = JSON.parse(raw);
          if (!obj?.ts || !obj?.data) return null;
          if (Date.now() - obj.ts > CACHE_TTL_MS) return null;
          return obj; // { ts, data }
        } catch {
          return null;
        }
      }

      function saveCache(data) {
        try {
          const obj = { ts: Date.now(), data };
          localStorage.setItem(CACHE_KEY, JSON.stringify(obj));
          return obj.ts;
        } catch {
          return Date.now();
        }
      }

      function clearCache() {
        try { localStorage.removeItem(CACHE_KEY); } catch { /* ignore */ }
      }

      async function fetchForecast({ force = false } = {}) {
        if (!force) {
          const cached = loadCache();
          if (cached) {
            return { data: cached.data, fetchedAt: cached.ts, source: "Cache" };
          }
        }

        const res = await fetch(SMHI_URL, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error(`SMHI svarade ${res.status} ${res.statusText}`);
        const data = await res.json();
        const ts = saveCache(data);
        return { data, fetchedAt: ts, source: "SMHI (n√§t)" };
      }

      function render(data) {
        container.innerHTML = "";

        const days = {};
        for (const h of data.timeSeries || []) {
          const date = (h.validTime || "").split("T")[0];
          if (!date) continue;
          (days[date] ||= []).push(h);
        }

        const dates = Object.keys(days).slice(0, 5);

        for (const date of dates) {
          const dayCard = document.createElement("div");
          dayCard.className = "day-card";

          const readableDate = new Date(date).toLocaleDateString("sv-SE", {
            weekday: "long",
            day: "numeric",
            month: "long"
          });

          dayCard.innerHTML = `
            <div class="day-header">
              <h2>${readableDate}</h2>
              <span>${days[date].length} timmar</span>
            </div>
            <div class="hourly"></div>
          `;

          const hourly = dayCard.querySelector(".hourly");

          for (const h of days[date]) {
            const time = new Date(h.validTime).toLocaleTimeString("sv-SE", {
              hour: "2-digit",
              minute: "2-digit"
            });

            const temp = param(h, "t", "‚Äî");
            const symb = param(h, "Wsymb2", null);
            const windSpeedRaw = param(h, "ws", NaN);
            const windDegRaw = param(h, "wd", 0);

            const windSpeed = Number(windSpeedRaw);
            const windDeg = Number(windDegRaw);

            const day = isDay(h.validTime);

            const [emoji, cssClass] = icon(symb ?? 0, day).split(" ");
            const desc = (symb && descriptions[symb]) ? descriptions[symb] : "Ok√§nt v√§der";

            const hourEl = document.createElement("div");
            hourEl.className = "hour";
            hourEl.innerHTML = `
              <div class="time">${time}</div>
              <div class="icon ${cssClass}">${emoji}</div>
              <div class="temp">${temp}¬∞C</div>
              <div class="desc">${desc}</div>
              <div class="wind">
                üå¨Ô∏è ${Number.isFinite(windSpeed) ? windSpeed : "‚Äî"} m/s ${windDirection(windDeg)}
                <br />
                <small>${windStrength(windSpeed)}</small>
              </div>
            `;

            hourly.appendChild(hourEl);
          }

          container.appendChild(dayCard);
        }
      }

      async function refresh({ force = false } = {}) {
        setLoading(true);
        try {
          setStatus({
            message: force ? "‚è≥ Tvingad uppdatering fr√•n SMHI‚Ä¶" : "‚è≥ Uppdaterar‚Ä¶",
            note: `<small>Plats: <strong>${PLACE}</strong></small>`
          });

          const { data, fetchedAt, source } = await fetchForecast({ force });
          render(data);

          setStatus({
            message: "‚úÖ Klart.",
            source,
            fetchedAt,
            note: `<small>Plats: <strong>${PLACE}</strong></small>`
          });
        } catch (err) {
          console.error(err);
          setStatus({
            message: `‚ùå Kunde inte h√§mta prognos.`,
            note: `<small>${err?.message ? err.message : ""}</small>`
          });
        } finally {
          setLoading(false);
        }
      }

      btnRefresh.addEventListener("click", () => refresh({ force: false }));
      btnForce.addEventListener("click", () => {
        clearCache(); // valfritt men tydligt f√∂r "tvinga"
        refresh({ force: true });
      });

      // Init
      refresh({ force: false });
    </script>
  </body>
</html>
