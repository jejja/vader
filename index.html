<!doctype html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V√§der ‚Äì dag & timme</title>

  <style>
    :root {
      --bg: #020617;
      --card: #1e293b;
      --accent: #38bdf8;
      --text: #e5e7eb;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: linear-gradient(160deg, #020617, #0f172a);
      color: var(--text);
    }

    header {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1rem 1rem;
      text-align: center;
    }

    h1 { margin: 0; color: var(--accent); }

    .sub {
      opacity: 0.8;
      margin-top: 0.4rem;
      font-size: 0.95rem;
    }

    .topbar {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1rem 0.6rem;
      display: flex;
      justify-content: center;
    }

    .icon-btn {
      width: 54px;
      height: 54px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 16px;
      cursor: pointer;
      user-select: none;
      transition: transform .08s ease, filter .15s ease;
    }
    .icon-btn:hover { filter: brightness(1.12); }
    .icon-btn:active { transform: scale(0.98); }
    .icon-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .icon-btn svg {
      width: 30px;
      height: 30px;
      display: block;
    }

    .icon-btn.loading svg {
      animation: spin 0.9s linear infinite;
    }

    .status {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 1rem 1rem;
      text-align: center;
      opacity: 0.92;
      font-size: 0.92rem;
      line-height: 1.35;
    }

    .days {
      max-width: 1100px;
      margin: auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .day-card {
      background: var(--card);
      border-radius: 18px;
      padding: 1rem;
      box-shadow: 0 20px 40px rgba(0,0,0,.4);
    }

    .day-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1rem;
      gap: 1rem;
    }

    .day-header h2 {
      margin: 0;
      font-size: 1.2rem;
      text-transform: capitalize;
    }

    .day-header span {
      opacity: 0.8;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    .hourly {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 0.75rem;
    }

    .hour {
      background: #0f172a;
      border-radius: 14px;
      padding: 0.75rem;
      text-align: center;
    }

    .time { font-size: 0.8rem; opacity: 0.7; }

    .icon {
      font-size: 1.6rem;
      margin: 0.3rem 0;
    }

    .temp {
      font-size: 1.3rem;
      font-weight: 800;
      color: var(--accent);
    }

    .desc {
      font-size: 0.75rem;
      opacity: 0.9;
      min-height: 2em;
    }

    .wind {
      font-size: 0.72rem;
      opacity: 0.9;
      margin-top: 0.3rem;
      line-height: 1.3;
      display: grid;
      gap: 4px;
      justify-items: center;
    }

    .windline {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      opacity: 0.95;
    }

    .wind-arrow {
      width: 14px;
      height: 14px;
      display: inline-block;
      transform-origin: 50% 50%;
      opacity: 0.9;
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      opacity: 0.8;
      padding: 0 1rem 2rem;
    }
    footer a { color: inherit; }

    .sun { animation: spin 8s linear infinite; }
    .moon { animation: pulse 3s ease-in-out infinite; }
    .cloud { animation: float 4s ease-in-out infinite; }
    .rain { animation: drop 1.5s linear infinite; }
    .snow { animation: float 3s ease-in-out infinite; }
    .sleet { animation: float 3s ease-in-out infinite; }
    .storm { animation: pulse 1.2s infinite; }
    .fog { animation: float 3.5s ease-in-out infinite; }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes pulse { 0%,100%{opacity:.6} 50%{opacity:1} }
    @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }
    @keyframes drop { to{transform:translateY(6px);opacity:.4} }
  </style>
</head>

<body>
  <header>
    <h1>üå¶Ô∏è V√§derprognos ‚Äì Karlskrona</h1>
    <div class="sub">Timprognos (5 dagar)</div>
  </header>

  <div class="topbar">
    <button id="btnRefresh" class="icon-btn" title="Uppdatera" aria-label="Uppdatera">
      <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M3 12a9 9 0 0 1 15.3-6.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M18 3v5h-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M21 12a9 9 0 0 1-15.3 6.3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        <path d="M6 21v-5h5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <div id="status" class="status" aria-live="polite"></div>
  <div id="days" class="days"></div>

  <footer>
    K√§lla: SMHI (CC BY 4.0)
    <a href="https://www.smhi.se/data/om-smhis-data/villkor-for-anvandning" target="_blank" rel="noopener noreferrer">Villkor</a>
  </footer>

<script>
  const PLACE = "Karlskrona";
  const LAT = 56.161;
  const LON = 15.587;

  const CACHE_TTL_MS = 15 * 60 * 1000;
  const CACHE_KEY = `smhi:pmp3g:v2:${LON}:${LAT}`;
  const URL = `https://opendata-download-metfcst.smhi.se/api/category/pmp3g/version/2/geotype/point/lon/${LON}/lat/${LAT}/data.json`;

  const container = document.getElementById("days");
  const statusEl = document.getElementById("status");
  const btnRefresh = document.getElementById("btnRefresh");

  const dayKeyFmt = new Intl.DateTimeFormat("sv-SE", {
    timeZone: "Europe/Stockholm",
    year: "numeric",
    month: "2-digit",
    day: "2-digit"
  });

  const hourFmt = new Intl.DateTimeFormat("sv-SE", {
    timeZone: "Europe/Stockholm",
    hour: "2-digit",
    hour12: false
  });

  function localDateKey(iso) {
    return dayKeyFmt.format(new Date(iso));
  }

  function isDayInStockholm(iso) {
    const h = Number(hourFmt.format(new Date(iso)));
    return h >= 6 && h < 18;
  }

  const descriptions = {
    1:"Klart",2:"N√§stan klart",3:"V√§xlande molnighet",4:"Halvklart",
    5:"Molnigt",6:"Mulet",7:"Dimma",
    8:"L√§tta regnskurar",9:"M√•ttliga regnskurar",10:"Kraftiga regnskurar",
    11:"√Öskv√§der",
    12:"L√§tta byar med bl√∂tsn√∂",13:"M√•ttliga byar med bl√∂tsn√∂",14:"Kraftiga byar med bl√∂tsn√∂",
    15:"L√§tta sn√∂byar",16:"M√•ttliga sn√∂byar",17:"Kraftiga sn√∂byar",
    18:"L√§tt regn",19:"M√•ttligt regn",20:"Kraftigt regn",
    21:"√Öska",
    22:"L√§tt bl√∂tsn√∂",23:"M√•ttlig bl√∂tsn√∂",24:"Kraftig bl√∂tsn√∂",
    25:"L√§tt sn√∂fall",26:"M√•ttligt sn√∂fall",27:"Kraftigt sn√∂fall"
  };

  function iconForWsymb2(code, day) {
    const fallback = { emoji: "‚òÅÔ∏è", cls: "cloud" };
    if (!Number.isFinite(code)) return fallback;

    if (code === 1 || code === 2) return day ? { emoji:"‚òÄÔ∏è", cls:"sun" } : { emoji:"üåô", cls:"moon" };
    if (code === 3 || code === 4) return day ? { emoji:"üå§Ô∏è", cls:"cloud" } : { emoji:"‚òÅÔ∏è", cls:"cloud" };
    if (code === 7) return { emoji:"üå´Ô∏è", cls:"fog" };
    if (code >= 5 && code <= 6) return { emoji:"‚òÅÔ∏è", cls:"cloud" };

    if (code >= 8 && code <= 10) return { emoji:"üå¶Ô∏è", cls:"rain" };
    if (code === 11 || code === 21) return { emoji:"‚õàÔ∏è", cls:"storm" };

    if (code >= 12 && code <= 14) return { emoji:"üå®Ô∏è", cls:"sleet" };
    if (code >= 15 && code <= 17) return { emoji:"‚ùÑÔ∏è", cls:"snow" };

    if (code >= 18 && code <= 20) return { emoji:"üåßÔ∏è", cls:"rain" };

    if (code >= 22 && code <= 24) return { emoji:"üå®Ô∏è", cls:"sleet" };
    if (code >= 25 && code <= 27) return { emoji:"‚ùÑÔ∏è", cls:"snow" };

    return fallback;
  }

  function windDirection(deg) {
    const dirs = ["N", "NO", "O", "SO", "S", "SV", "V", "NV"];
    return dirs[Math.round(deg / 45) % 8];
  }

  function windStrength(ms) {
    if (!Number.isFinite(ms)) return "‚Äî";
    if (ms < 1) return "Lugnt";
    if (ms < 4) return "Svag vind";
    if (ms < 8) return "M√•ttlig vind";
    if (ms < 14) return "Frisk vind";
    if (ms < 21) return "H√•rd vind";
    return "Storm";
  }

  function param(h, name, fallback=null) {
    const p = h.parameters?.find(x => x.name === name);
    return (p && Array.isArray(p.values) && p.values.length) ? p.values[0] : fallback;
  }

  function fmt(msOrIso) {
    return new Intl.DateTimeFormat("sv-SE", { dateStyle:"medium", timeStyle:"short" }).format(new Date(msOrIso));
  }

  function loadCache() {
    try {
      const raw = localStorage.getItem(CACHE_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj?.ts || !obj?.data) return null;
      if (Date.now() - obj.ts > CACHE_TTL_MS) return null;
      return obj;
    } catch {
      return null;
    }
  }

  function saveCache(data) {
    const obj = { ts: Date.now(), data };
    try { localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); } catch {}
    return obj.ts;
  }

  async function fetchForecast({ force = false } = {}) {
    if (!force) {
      const cached = loadCache();
      if (cached) return { data: cached.data, fetchedAt: cached.ts };
    }
    const res = await fetch(URL, { headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error(`SMHI svarade ${res.status} ${res.statusText}`);
    const data = await res.json();
    const fetchedAt = saveCache(data);
    return { data, fetchedAt };
  }

  function getSmhiForecastTimestamp(data) {
    return data?.approvedTime || data?.createdTime || data?.referenceTime || null;
  }

  function feelsLikeC(tempC, windMs) {
    if (!Number.isFinite(tempC) || !Number.isFinite(windMs)) return null;
    const windKmh = windMs * 3.6;
    if (tempC > 10 || windKmh < 4.8) return null;
    const wci = 13.12 + 0.6215 * tempC - 11.37 * Math.pow(windKmh, 0.16) + 0.3965 * tempC * Math.pow(windKmh, 0.16);
    return Math.round(wci * 10) / 10;
  }

  function windArrowSvg(fromDeg) {
    const d = Number.isFinite(fromDeg) ? fromDeg : 0;
    const rot = d + 180;
    return `
      <svg class="wind-arrow" viewBox="0 0 24 24" fill="none"
           style="transform: rotate(${rot}deg)" aria-hidden="true">
        <path d="M12 20V6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        <path d="M7.5 10.5L12 6l4.5 4.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
  }

  function render(data) {
    container.innerHTML = "";

    const days = {};
    for (const h of (data.timeSeries || [])) {
      const key = localDateKey(h.validTime);
      (days[key] ||= []).push(h);
    }

    const keys = Object.keys(days).slice(0, 5);

    for (const key of keys) {
      const card = document.createElement("div");
      card.className = "day-card";

      const title = new Date(key + "T12:00:00").toLocaleDateString("sv-SE", {
        weekday: "long",
        day: "numeric",
        month: "long"
      });

      card.innerHTML = `
        <div class="day-header">
          <h2>${title}</h2>
          <span>${days[key].length} timmar</span>
        </div>
        <div class="hourly"></div>
      `;

      const hourly = card.querySelector(".hourly");

      for (const h of days[key]) {
        const time = new Date(h.validTime).toLocaleTimeString("sv-SE", { hour:"2-digit", minute:"2-digit" });

        const temp = Number(param(h, "t", NaN));
        const symb = Number(param(h, "Wsymb2", NaN));
        const windSpeed = Number(param(h, "ws", NaN));
        const windDeg = Number(param(h, "wd", NaN));
        const gust = Number(param(h, "gust", NaN));

        const day = isDayInStockholm(h.validTime);
        const { emoji, cls } = iconForWsymb2(symb, day);
        const desc = Number.isFinite(symb) ? (descriptions[symb] || "V√§der") : "V√§der";

        const fl = feelsLikeC(temp, windSpeed);
        const feels = fl === null ? "" : ` ¬∑ k√§nns som ${fl}¬∞`;

        const gustText = Number.isFinite(gust) ? ` ¬∑ byar ${gust} m/s` : "";

        const hourEl = document.createElement("div");
        hourEl.className = "hour";
        hourEl.innerHTML = `
          <div class="time">${time}</div>
          <div class="icon ${cls}">${emoji}</div>
          <div class="temp">${Number.isFinite(temp) ? temp : "‚Äî"}¬∞C</div>
          <div class="desc">${desc}${feels}</div>
          <div class="wind">
            <div class="windline">
              ${windArrowSvg(windDeg)}
              <span>${Number.isFinite(windSpeed) ? windSpeed : "‚Äî"} m/s ${Number.isFinite(windDeg) ? windDirection(windDeg) : ""}</span>
            </div>
            <small>${windStrength(windSpeed)}${gustText}</small>
          </div>
        `;
        hourly.appendChild(hourEl);
      }

      container.appendChild(card);
    }
  }

  function setLoading(isLoading) {
    btnRefresh.disabled = isLoading;
    btnRefresh.classList.toggle("loading", isLoading);
  }

  async function refresh(force = false) {
    setLoading(true);
    statusEl.textContent = "Uppdaterar‚Ä¶";

    try {
      const { data, fetchedAt } = await fetchForecast({ force });
      render(data);

      const smhiTime = getSmhiForecastTimestamp(data);
      const smhiLine = smhiTime ? `SMHI prognos: <strong>${fmt(smhiTime)}</strong>` : `SMHI prognos: <strong>ok√§nd</strong>`;
      statusEl.innerHTML = `Senast h√§mtad: <strong>${fmt(fetchedAt)}</strong><br>${smhiLine}`;
    } catch (e) {
      statusEl.textContent = "Kunde inte h√§mta prognos.";
    } finally {
      setLoading(false);
    }
  }

  btnRefresh.addEventListener("click", () => refresh(true));
  refresh(false);
</script>
</body>
</html>
